---
title: "RprojectScript"
output:
  html_document: default
  pdf_document: default
date: "2023-07-31"
---

## Setup libraries and folders

```{r setup, include=FALSE}
# Remove  all the objects from environment 
rm(list=ls())  

# Set the path to place with packages
.libPaths("C:/Computerteknologi/10_semester/Rcourse")
.libPaths()


# Load the selected packages 
pack<-c("car","sandwich","lmtest","RColorBrewer","mgcv","foreign","xtable"
        ,"AER","stargazer", "MASS")

lapply(pack, require, character.only=T)

# get the working path
getwd()

# Set all the working paths
data_path<-"C:/Computerteknologi/10_semester/Rcourse/project/data"
data_graph <-"C:/Computerteknologi/10_semester/Rcourse/project/graph"
data_results <-"C:/Computerteknologi/10_semester/Rcourse/project/result"
data_scripts <-"C:/Computerteknologi/10_semester/Rcourse/project/script"
setwd(data_path)

#get directory
dir()

#get dataset into data
data = read.csv("mortality2.csv",header = FALSE,skip = 0)
```

The mortality rate for infant is the used dataset in this project which is assigned to the variable data above. The dataset come from data.worldbank.org. URL: <https://data.worldbank.org/indicator/SP.DYN.IMRT.IN?view=chart>

## Preprocessing of data

```{r}

#get all the rows of countries which name not include income og exclude
data_countries = data[!grepl("exclud",data$V1),]
data_countries = data[!grepl("income",data$V1),]

#data of areas (include and exclude income)
data_areas = data


data_income = data[grepl("income",data$V1),]

data_all = data_areas[-(1:3),-1]



rownames(data_all) = data_areas[-(1:3),1]
colnames(data_all) = data_areas[3,-(1:1)] 


data_all = data_all[,-4:-33]
data_all = data_all[,-35:-37]
data_all = data_all[rowSums(is.na(data_all))<5,]

data_countries2 = data_countries[-(1:3),-1]

rownames(data_countries2) = data_countries[-(1:3),1]
colnames(data_countries2) = data_countries[3,-(1:1)] 


data_countries2 = data_countries2[,-4:-33]
data_countries2 = data_countries2[,-35:-37]
data_countries2 = data_countries2[rowSums(is.na(data_countries2))<5,]


continentCodes = c("EAP","ECA","LAC","MNA","SSA","EAS","ECS","LCN","MEA","SSF")

data_continents = data_all[data_all$`Country Code` %in% continentCodes,]

```

Webscraping webpage to get areas, unions and continents out. Only countries will be in country dataset

```{r}
#Loading the rvest package
library('rvest')

#url to be webscaped
url <- 'https://www.iban.com/country-codes'


#Read HTML code site
webpage <- read_html(url)

#get the table data on page
country_table <- html_element(webpage, "table.table") %>%
  html_table()

sum1 = sum(data_all$`Country Code` %in% country_table$`Alpha-3 code`)
#webpage %>% html_elements("table#Country-Codes-A-C")
#drivers_F1$Country

data_countries2=data_all[!data_all$`Country Code` %in% country_table$`Alpha-3 code`,]

data_countries2=data_countries2[data_countries2$`Country Code`!="XKX",]

data_categories=data_countries2
data_countries = data_all[data_all$`Country Code` %in% country_table$`Alpha-3 code`,]
```

Webscraping to get the HDI list:

```{r}
#Load the rvest package
library('rvest')

#url to be webscaped
url <- 'https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index'


#Reading the HTML code from the website
webpage <- read_html(url)

#get the table data on page
hdi_table <- html_element(webpage, "table.sortable") %>%
  html_table()

hdi_list = hdi_table[,c("Rank","Nation")]

#get rid of first row containing column titles
hdi_list = hdi_list[-1,]

#webpage %>% html_elements("table#Country-Codes-A-C")
#drivers_F1$Country
#data3=data2[!data2$`Country Code` %in% drivers_F1$`Alpha-3 code`,]
#data3=data3[data3$`Country Code`!="XKX",]

#data_categories=data3
```

## Analytics of data

-   Connection between immortality and HDI

-   Developing over time

-   Countries from lowest to highest immortality

-   Categories of countries

-   Comparison of Low / medium / high income countries with

plots:

-   Map with the locations of the world countries'

```{r}
immortal1990 = data_countries[,4]
immortal2020 = data_countries[,34]

barplot(sort(immortal1990))
barplot(sort(immortal2020))
df = data.frame(rownames(data_countries),immortal1990,immortal2020)
#barplot(df, col = c("#993404", "#FB6A4A"),height=immortal1990)

#library(ggplot2)
#ggplot(df) +
#  aes(x = df$rownames.data_countries.) +
#  geom_col(aes(y = df$immortal1990, fill = "total"))+
#  geom_col(aes(y = df$immortal2020, fill = "ui"))+
#  labs(x=NULL, y = "Number of papers") +
#  scale_fill_manual(values = c(immortal1990 = "grey", immortal2020 = #"dodgerblue4")) +
#  theme_bw()+
#  theme(panel.border = element_blank(), panel.grid.major = #element_blank(),
#        panel.grid.minor = element_blank(), axis.line = element_line#(colour = "black"))
library(grid)
library(gridBase)

#1990
sortedImmortal=df[order(df$immortal1990),]
headAndTail= head(sortedImmortal,5)
headAndTail = rbind(headAndTail,tail(sortedImmortal,5))

midpts = barplot(headAndTail$immortal1990,ylim = c(0,180))

vps <- baseViewports()
pushViewport(vps$inner, vps$figure, vps$plot)

grid.text(headAndTail$rownames.data_countries.,
    x = unit(midpts, "native"), y=unit(-2, "lines"),
    just="right", rot=50)

#2020
sortedImmortal=df[order(df$immortal2020),]
headAndTail= head(sortedImmortal,5)
headAndTail = rbind(headAndTail,tail(sortedImmortal,5))

midpts = barplot(headAndTail$immortal2020,ylim = c(0,180))

vps <- baseViewports()
pushViewport(vps$inner, vps$figure, vps$plot)

grid.text(headAndTail$rownames.data_countries.,
    x = unit(midpts, "native"), y=unit(-2, "lines"),
    just="right", rot=50)

```

Connection between HDI and immortality

```{r}
matchHdiList = hdi_list[hdi_list$Nation %in% rownames(data_countries),]
matchDatacountries = data_countries[rownames(data_countries) %in% hdi_list$Nation,]


matchHdiList = matchHdiList[order(matchHdiList$Nation),]
matchDatacountries = matchDatacountries[order(rownames(matchDatacountries)),]

plot(matchHdiList$Rank,matchDatacountries[,34],xlab = "Countries' HDI ranking (1 = highest human development)",ylab = "Mortality rate, infant (per 1,000 live births)")
```

World maps plots:

```{r}
library(rworldmap)


#populationData = data.frame()
joinData <- joinCountryData2Map( sortedImmortal,
                                 joinCode = "NAME",
                                 nameJoinColumn = "rownames.data_countries.")
theMap1990 <- mapCountryData( joinData, nameColumnToPlot="immortal1990", addLegend=TRUE,catMethod = seq(1, 180, len = 20))
theMap2020 <- mapCountryData( joinData, nameColumnToPlot="immortal2020", addLegend=TRUE,catMethod = seq(1, 180, len = 20))
#do.call( addMapLegend, c(theMap1990, legendWidth=1, legendMar = 2))


#do.call( addMapLegend, c(theMap2020, legendWidth=1, legendMar = 2))
```

### Countries development from 1990 to 2020 (loop)

```{r}

#number of rows in immortal dataframe
N = nrow(sortedImmortal)

#by standard all the values in the column is set to NA
sortedImmortal$DevPercentage = NA

#put in the development from 1990 to 2020 in each row
for (i in 1:N) {
  diff = (sortedImmortal$immortal2020[i]-sortedImmortal$immortal1990[i])/sortedImmortal$immortal1990[i]
  
  #if(diff < -0.2) {
  #  sortedImmortal$DevPercentage[i] = diff
  #}
  
}

#
min_country = sortedImmortal[which.min(sortedImmortal$DevPercentage),]

max_country = sortedImmortal[which.max(sortedImmortal$DevPercentage),]

min_in_percentage = format(round(100*min_country$DevPercentage, 2), nsmall = 2)

max_in_percentage = format(round(100*max_country$DevPercentage, 2), nsmall = 2)

print(paste("Highest reducing is ",min_country$rownames.data_countries.," with ",min_in_percentage," %"))

print(paste("Lowest reducing is ",max_country$rownames.data_countries.," with ",max_in_percentage," %"))
```
