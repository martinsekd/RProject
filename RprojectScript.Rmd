---
title: "RprojectScript"
output:
  html_document: default
  pdf_document: default
date: "2023-07-31"
---

## Setup libraries and folders

```{r setup, include=FALSE}
# Remove  all the objects from environment 
rm(list=ls())  

# Set the path to place with packages
.libPaths("C:/Computerteknologi/10_semester/Rcourse")
.libPaths()


# Load the selected packages 
pack<-c("car","sandwich","lmtest","RColorBrewer","mgcv","foreign","xtable"
        ,"AER","stargazer", "MASS")

lapply(pack, require, character.only=T)

# get the working path
getwd()

# Set all the working paths
data_path<-"C:/Computerteknologi/10_semester/Rcourse/project/data"
data_graph <-"C:/Computerteknologi/10_semester/Rcourse/project/graph"
data_results <-"C:/Computerteknologi/10_semester/Rcourse/project/result"
data_scripts <-"C:/Computerteknologi/10_semester/Rcourse/project/script"
setwd(data_path)

#get directory
dir()

#get dataset into data
data = read.csv("mortality2.csv",header = FALSE,skip = 0)
```

The mortality rate for infant is the used dataset in this project which is assigned to the variable data above. The dataset come from data.worldbank.org. URL: <https://data.worldbank.org/indicator/SP.DYN.IMRT.IN?view=chart>

## Preprocessing of data

```{r}

#get all the rows of countries which name not include income og exclude
data_countries = data[!grepl("exclud",data$V1),]
data_countries = data[!grepl("income",data$V1),]

#data of areas (include and exclude income)
data_areas = data


data_income = data[grepl("income",data$V1),]

data_all = data_areas[-(1:3),-1]



rownames(data_all) = data_areas[-(1:3),1]
colnames(data_all) = data_areas[3,-(1:1)] 


data_all = data_all[,-4:-33]
data_all = data_all[,-35:-37]
data_all = data_all[rowSums(is.na(data_all))<5,]

data_countries2 = data_countries[-(1:3),-1]

rownames(data_countries2) = data_countries[-(1:3),1]
colnames(data_countries2) = data_countries[3,-(1:1)] 


data_countries2 = data_countries2[,-4:-33]
data_countries2 = data_countries2[,-35:-37]
data_countries2 = data_countries2[rowSums(is.na(data_countries2))<5,]


continentCodes = c("EAP","ECA","LAC","MNA","SSA","EAS","ECS","LCN","MEA","SSF")

data_continents = data_all[data_all$`Country Code` %in% continentCodes,]

```

Webscraping webpage to get areas, unions and continents out. Only countries will be in country dataset

```{r}
#Loading the rvest package
library('rvest')

#url to be webscaped
url <- 'https://www.iban.com/country-codes'


#Read HTML code site
webpage <- read_html(url)

#get the table data on page
country_table <- html_element(webpage, "table.table") %>%
  html_table()

sum1 = sum(data_all$`Country Code` %in% country_table$`Alpha-3 code`)
#webpage %>% html_elements("table#Country-Codes-A-C")
#drivers_F1$Country

data_countries2=data_all[!data_all$`Country Code` %in% country_table$`Alpha-3 code`,]

data_countries2=data_countries2[data_countries2$`Country Code`!="XKX",]

data_categories=data_countries2
data_countries = data_all[data_all$`Country Code` %in% country_table$`Alpha-3 code`,]
```

Webscraping to get the HDI list:

```{r}
#Load the rvest package
library('rvest')

#url to be webscaped
url <- 'https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index'


#Reading the HTML code from the website
webpage <- read_html(url)

#get the table data on page
hdi_table <- html_element(webpage, "table.sortable") %>%
  html_table()

hdi_list = hdi_table[,c("Rank","Nation")]

#get rid of first row containing column titles
hdi_list = hdi_list[-1,]

#webpage %>% html_elements("table#Country-Codes-A-C")
#drivers_F1$Country
#data3=data2[!data2$`Country Code` %in% drivers_F1$`Alpha-3 code`,]
#data3=data3[data3$`Country Code`!="XKX",]

#data_categories=data3
```

## Analytics of data

-   Connection between immortality and HDI

-   Developing over time

-   Countries from lowest to highest immortality

-   Categories of countries

-   Comparison of Low / medium / high income countries with

plots:

-   Map with the locations of the world countries'

```{r}
immortal1990 = data_countries[,4]
immortal2020 = data_countries[,34]

barplot(sort(immortal1990))
barplot(sort(immortal2020))
df = data.frame(rownames(data_countries),immortal1990,immortal2020)
#barplot(df, col = c("#993404", "#FB6A4A"),height=immortal1990)

#library(ggplot2)
#ggplot(df) +
#  aes(x = df$rownames.data_countries.) +
#  geom_col(aes(y = df$immortal1990, fill = "total"))+
#  geom_col(aes(y = df$immortal2020, fill = "ui"))+
#  labs(x=NULL, y = "Number of papers") +
#  scale_fill_manual(values = c(immortal1990 = "grey", immortal2020 = #"dodgerblue4")) +
#  theme_bw()+
#  theme(panel.border = element_blank(), panel.grid.major = #element_blank(),
#        panel.grid.minor = element_blank(), axis.line = element_line#(colour = "black"))
library(grid)
library(gridBase)

#1990
sortedImmortal=df[order(df$immortal1990),]
headAndTail= head(sortedImmortal,5)
headAndTail = rbind(headAndTail,tail(sortedImmortal,5))

midpts = barplot(headAndTail$immortal1990,ylim = c(0,180))

vps <- baseViewports()
pushViewport(vps$inner, vps$figure, vps$plot)

grid.text(headAndTail$rownames.data_countries.,
    x = unit(midpts, "native"), y=unit(-2, "lines"),
    just="right", rot=50)

#2020
sortedImmortal=df[order(df$immortal2020),]
headAndTail= head(sortedImmortal,5)
headAndTail = rbind(headAndTail,tail(sortedImmortal,5))

midpts = barplot(headAndTail$immortal2020,ylim = c(0,180))

vps <- baseViewports()
pushViewport(vps$inner, vps$figure, vps$plot)

grid.text(headAndTail$rownames.data_countries.,
    x = unit(midpts, "native"), y=unit(-2, "lines"),
    just="right", rot=50)

```

Connection between HDI and immortality

```{r}
matchHdiList = hdi_list[hdi_list$Nation %in% rownames(data_countries),]
matchDatacountries = data_countries[rownames(data_countries) %in% hdi_list$Nation,]


matchHdiList = matchHdiList[order(matchHdiList$Nation),]
matchDatacountries = matchDatacountries[order(rownames(matchDatacountries)),]

plot(matchHdiList$Rank,matchDatacountries[,34],xlab = "Countries' HDI ranking (1 = highest human development)",ylab = "Mortality rate, infant (per 1,000 live births)")
```

World maps plots:

```{r}
library(rworldmap)


#populationData = data.frame()
joinData <- joinCountryData2Map( sortedImmortal,
                                 joinCode = "NAME",
                                 nameJoinColumn = "rownames.data_countries.")
theMap1990 <- mapCountryData( joinData, nameColumnToPlot="immortal1990", addLegend=TRUE,catMethod = seq(1, 180, len = 20))
theMap2020 <- mapCountryData( joinData, nameColumnToPlot="immortal2020", addLegend=TRUE,catMethod = seq(1, 180, len = 20))
#do.call( addMapLegend, c(theMap1990, legendWidth=1, legendMar = 2))


#do.call( addMapLegend, c(theMap2020, legendWidth=1, legendMar = 2))
```

### Countries development from 1990 to 2020 (loop)

```{r}

#number of rows in immortal dataframe
N = nrow(sortedImmortal)

#by standard all the values in the column is set to NA
sortedImmortal$DevPercentage = NA

#put in the development from 1990 to 2020 in each row
for (i in 1:N) {
  diff = (sortedImmortal$immortal2020[i]-sortedImmortal$immortal1990[i])/sortedImmortal$immortal1990[i]
  
  #if(diff < -0.2) {
  #  sortedImmortal$DevPercentage[i] = diff
  #}
  
}

#
min_country = sortedImmortal[which.min(sortedImmortal$DevPercentage),]

max_country = sortedImmortal[which.max(sortedImmortal$DevPercentage),]

min_in_percentage = format(round(100*min_country$DevPercentage, 2), nsmall = 2)

max_in_percentage = format(round(100*max_country$DevPercentage, 2), nsmall = 2)

print(paste("Highest reducing is ",min_country$rownames.data_countries.," with ",min_in_percentage," %"))

print(paste("Lowest reducing is ",max_country$rownames.data_countries.," with ",max_in_percentage," %"))
```

## Preprocessing of data for looking at income

```{r}
#data = API_SP.DYN.IMRT.IN_DS2_en_csv_v2_5728798
data_income <- data
colnames(data_income) <- data[3,]
data_income = data_income[grepl("income",data_income$`Country Name`),]
data_income = data_income[!grepl("exc",data_income$`Country Name`),]

rownames(data_income) = data_income$`Country Name`
data_income2 = data_income[,-1]

data_income2 = data_income2[,-4:-33]
data_income2  = data_income2 [,-35:-37]
```

Another preprocessing of data for income

```{r}
library("dplyr")

#Making a new dataframe, and filtering the rows out only containing information about the income 
data_income <- data 
data_income <- filter(data_income,  V1 %in% c("High income", 
                                                            "Country Name", 
                                                            "Low income", 
                                                            "Lower middle income", 
                                                            "Low & middle income",
                                                            "Middle income",
                                                            "Upper middle income"))

#Transposing the dataframe to swap the column and rows. 
data_income <- data.frame(t(data_income))

#Deleting unwanted rows/columns with NA's. 
data_income = data_income[-67:-68,]
data_income = data_income[-2:-34,]

#Changing the colnames and remvoing first column
colnames(data_income) = data_income[1,]
colnames(data_income)[1] = "Year"
data_income = data_income[-1,]

#Removing excssive digests for the colums 
data_income$`Year` =  gsub("\\..*","",data_income$`Year`)
```

### Plots

```{r}
library(ggplot2)
library(MASS) 
library(reshape2) 
library(reshape)
library(geomtextpath)

#melt data frame into long format
Plot_income <- melt(data_income,  id.vars = 'Year', variable.name = 'series')

#The Year and Values, are both defined as characters. So this need to be changed
is.character(Plot_income$value)
is.character(Plot_income$Year)

#Changing it to numeric
Plot_income$Year <- as.numeric(Plot_income$`Year`)
Plot_income$Value <- as.numeric(Plot_income$value)
Plot_income =Plot_income[,c(-3)]


#Plotting - two different ways

ggplot(Plot_income, aes(Year, Value, colour = variable )) +
  ggtitle("Mortality dependences on income") +
  xlab("Year") + 
  ylab("Mortality rate, infant (per 1,000 live births)") + 
    geom_point() +
  geom_line() 



ggplot(Plot_income, aes(Year, Value, colour = variable )) +
  ggtitle("Mortality dependences on income") +
  xlab("Year") + 
  ylab("Mortality rate, infant (per 1,000 live births)")  +
  geom_textpath(
     label = Plot_income$variable
  ) +theme_bw() + 
  theme(legend.position = "none")
```

Income statistics and comparison

```{r}
Sta_DF <- data.frame 

#First making a new dataframe, only containg the data from years 1990 and 2020, to be able to see the difference between these two
Sta_DF = Plot_income[Plot_income$Year %in% c('1990','2020'),]

#To distingush the variable newme, we add the years to the variable neames 
Sta_DF$con = paste(Sta_DF$variable, Sta_DF$Year)


#Plotting the values for 1990 and 2020 for each of the incomes in a bar plot, to easily see the difference 
q <- ggplot(Sta_DF, aes(x = con , y= Value,  colour = variable, fill = variable ))  + 
         geom_bar(stat="identity") +
    ggtitle("Mortality dependences on income") +
  xlab("") + 
  ylab("Mortality rate, infant (per 1,000 live births)") 
 q + theme_bw() + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), panel.border = element_blank()) 
```

```{r}
library(ggpubr)

#making t-test for each income group - using Welch two sample t-test, because we dont know id the population size is the same.

t.test(Sta_DF$Value, c(1:2), mu=0)
t.test(Sta_DF$Value, c(3:4), mu=0)
t.test(Sta_DF$Value, c(5:6), mu=0)
t.test(Sta_DF$Value, c(7:8), mu=0)
t.test(Sta_DF$Value, c(9:10), mu=0)
t.test(Sta_DF$Value, c(11:2), mu=0)

#Here it is clear to see that all the p-values are below 0.05, meaning the reduction is significant. 

```
